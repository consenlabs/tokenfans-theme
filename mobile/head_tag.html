
<script type="text/x-handlebar" data-template-name="composer">
  {{#composer-body composer=model
                   showPreview=showPreview
                   openIfDraft="openIfDraft"
                   typed="typed"
                   cancelled="cancelled"
                   save="save"}}
                   
    {{#if visible}}
        {{composer-messages composer=model
                            messageCount=messageCount
                            addLinkLookup="addLinkLookup"}}
        {{#if model.viewOpen}}
          <div class="reply-area {{if canEditTags 'with-tags'}}">
  
            <div class='submit-panel'>
  
              {{#if site.mobileView}}
                <a href {{action "cancel"}} class='cancel' tabindex="6" title="{{i18n 'cancel'}}">
                  {{#if canEdit}}
                    {{d-icon "times"}}
                  {{else}}
                    {{d-icon "chevron-left"}}
                  {{/if}}
                </a>
              {{else}}
                <a href {{action "cancel"}} class='cancel' tabindex="6" >{{i18n 'cancel'}}</a>
              {{/if}}
  
              {{plugin-outlet name="composer-fields-below" args=(hash model=model)}}
  
              <div class='save-or-cancel'>
                {{composer-save-button action=(action "save")
                                       icon=model.saveIcon
                                       label=model.saveLabel
                                       disableSubmit=disableSubmit}}
                {{#if site.mobileView}}
  
                {{else}}
                  <a href {{action "cancel"}} class='cancel' tabindex="6" >{{i18n 'cancel'}}</a>
                {{/if}}
  
                {{#if isUploading}}
                  <div id="file-uploading">
                    {{loading-spinner size="small"}}<span>{{i18n 'upload_selector.uploading'}} {{uploadProgress}}%</span>
                    {{#if isCancellable}}
                      <a href id="cancel-file-upload" {{action "cancelUpload"}}>{{d-icon "times"}}</a>
                    {{/if}}
                  </div>
                {{/if}}
                <div id='draft-status' class="{{if isUploading 'hidden'}}">
                  {{model.draftStatus}}
                </div>
              </div>
  
              {{#if site.mobileView}}
  
              {{else}}
                <div class="composer-bottom-right">
                  <a href {{action "togglePreview"}} class='toggle-preview'>{{{toggleText}}}</a>
                </div>
              {{/if}}
  
            </div>
  
            <div class='composer-fields'>
              {{plugin-outlet name="composer-open" args=(hash model=model)}}
              {{#unless site.mobileView}}
                <div class='reply-to'>
                  <div class="reply-details">
                    {{composer-action-title model=model canWhisper=canWhisper tabindex=8}}
  
                    {{#unless site.mobileView}}
                      {{#if whisperOrUnlistTopicText}}
                        <span class='whisper'>({{whisperOrUnlistTopicText}})</span>
                      {{/if}}
                      {{#if model.noBump}}
                        <span class="no-bump">{{d-icon "anchor"}}</span>
                      {{/if}}
                    {{/unless}}
  
                    {{#if canEdit}}
                      {{#link-to-input onClick=(action "displayEditReason") showInput=showEditReason key="composer.show_edit_reason" class="display-edit-reason"}}
                        {{text-field value=editReason tabindex="7" id="edit-reason" maxlength="255" placeholderKey="composer.edit_reason_placeholder"}}
                      {{/link-to-input}}
                    {{/if}}
                  </div>
                  {{composer-toggles composeState=model.composeState
                            toggleComposer=(action "toggle")
                            toggleToolbar=(action "toggleToolbar")}}
                </div>
              {{/unless}}
  
              {{#if model.canEditTitle}}
                {{#if model.creatingPrivateMessage}}
                  <div class='user-selector'>
                    {{composer-user-selector topicId=topicModel.id
                                             usernames=model.targetUsernames
                                             hasGroups=model.hasTargetGroups
                                             focusTarget=focusTarget
                                             class="users-input"}}
                    {{#if showWarning}}
                      <label class='add-warning'>
                        {{input type="checkbox" checked=model.isWarning tabindex="3"}}
                        {{i18n "composer.add_warning"}}
                      </label>
                    {{/if}}
                  </div>
                {{/if}}
  
                <div class="title-and-category {{if showPreview 'with-preview'}}">
  
                  {{composer-title composer=model lastValidatedAt=lastValidatedAt focusTarget=focusTarget}}
  
                  {{#if model.showCategoryChooser}}
                    <div class="category-input">
                      {{category-chooser
                        fullWidthOnMobile=true
                        value=model.categoryId
                        scopedCategoryId=scopedCategoryId
                        tabindex="3"}}
                      {{popup-input-tip validation=categoryValidation}}
                    </div>
                  {{/if}}
                  {{#if canEditTags}}
                    {{mini-tag-chooser tags=model.tags tabindex="4" categoryId=model.categoryId minimum=model.minimumRequiredTags}}
                    {{popup-input-tip validation=tagValidation}}
                  {{/if}}
                </div>
              {{/if}}
  
              {{plugin-outlet name="composer-fields" args=(hash model=model)}}
  
            </div>
  
            {{composer-editor topic=topic
                              composer=model
                              lastValidatedAt=lastValidatedAt
                              canWhisper=canWhisper
                              storeToolbarState="storeToolbarState"
                              onPopupMenuAction=(action "onPopupMenuAction")
                              popupMenuOptions=popupMenuOptions
                              draftStatus=model.draftStatus
                              isUploading=isUploading
                              allowUpload=allowUpload
                              uploadIcon=uploadIcon
                              isCancellable=isCancellable
                              uploadProgress=uploadProgress
                              groupsMentioned="groupsMentioned"
                              cannotSeeMention="cannotSeeMention"
                              importQuote="importQuote"
                              togglePreview="togglePreview"
                              showToolbar=showToolbar
                              showUploadSelector="showUploadSelector"
                              afterRefresh="afterRefresh"}}
          </div>
  
        {{else}}
          <div class='saving-text'>
            {{#if model.createdPost}}
              {{i18n 'composer.saved'}} <a class='permalink' href="{{unbound createdPost.url}}" {{action "viewNewReply"}}>{{i18n 'composer.view_new_post'}}</a>
            {{else}}
              {{i18n 'composer.saving'}} {{loading-spinner size="small"}}
            {{/if}}
          </div>
  
          <div class='draft-text'>
            {{#if model.topic}}
              {{d-icon "mail-forward"}} {{{draftTitle}}}
            {{else}}
              {{i18n "composer.saved_draft"}}
            {{/if}}
          </div>
  
          {{composer-toggles composeState=model.composeState
            toggleComposer=(action "toggle")
            toggleToolbar=(action "toggleToolbar")}}
  
        {{/if}}
  
    {{/if}}
  
  {{/composer-body}}
  
  </script>
  
<script type="text/discourse-plugin" version="0.8">
  api.reopenWidget("header-icons", {
    html(attrs) {
      if (this.siteSettings.login_required && !this.currentUser) {
        return [];
      }
  
      const hamburger = this.attach("header-dropdown", {
        title: "hamburger_menu",
        icon: "bars",
        iconId: "toggle-hamburger-menu",
        active: attrs.hamburgerVisible,
        action: "toggleHamburger",
        href: "",
        contents() {
          if (!attrs.flagCount) {
            return;
          }
          return h(
            "div.badge-notification.flagged-posts",
            {
              attributes: {
                title: I18n.t("notifications.total_flagged")
              }
            },
            attrs.flagCount
          );
        }
      });
  
      const search = this.attach("header-dropdown", {
        title: "search.title",
        icon: "search",
        iconId: "search-button",
        action: "toggleSearchMenu",
        active: attrs.searchVisible,
        href: Discourse.getURL("/search")
      });
  
      const icons = [search];
      
      if (this.currentUser && this.currentUser.admin) {
        icons.push(hamburger);
      }

      if (attrs.user) {
        icons.push(
          this.attach("user-dropdown", {
            active: attrs.userVisible,
            action: "toggleUserMenu",
            ringBackdrop: attrs.ringBackdrop,
            user: attrs.user
          })
        );
      }
  
      return icons;
    }
  });

  api.modifyClass("controller:composer", {
    open(opts) {
      opts = opts || { };
      if (!opts.categoryId) {
        opts.categoryId = 11
      }
  
      if (!opts.draftKey) {
        alert("composer was opened without a draft key");
        throw new Error("composer opened without a proper draft key");
      }
      const self = this;
      let composerModel = this.get("model");
  
      if (
        opts.ignoreIfChanged &&
        composerModel &&
        composerModel.composeState !== Composer.CLOSED
      ) {
        return;
      }
  
      this.setProperties({
        showEditReason: false,
        editReason: null,
        scopedCategoryId: null
      });
  
      // If we show the subcategory list, scope the categories drop down to
      // the category we opened the composer with.
      if (opts.categoryId && opts.draftKey !== "reply_as_new_topic") {
        const category = this.site.categories.findBy("id", opts.categoryId);
        if (
          category &&
          (category.get("show_subcategory_list") ||
            category.get("parentCategory.show_subcategory_list"))
        ) {
          this.set("scopedCategoryId", opts.categoryId);
        }
      }
  
      // If we want a different draft than the current composer, close it and clear our model.
      if (
        composerModel &&
        opts.draftKey !== composerModel.draftKey &&
        composerModel.composeState === Composer.DRAFT
      ) {
        this.close();
        composerModel = null;
      }
  
      return new Ember.RSVP.Promise(function(resolve, reject) {
        if (composerModel && composerModel.get("replyDirty")) {
          // If we're already open, we don't have to do anything
          if (
            composerModel.get("composeState") === Composer.OPEN &&
            composerModel.get("draftKey") === opts.draftKey &&
            !opts.action
          ) {
            return resolve();
          }
  
          // If it's the same draft, just open it up again.
          if (
            composerModel.get("composeState") === Composer.DRAFT &&
            composerModel.get("draftKey") === opts.draftKey
          ) {
            composerModel.set("composeState", Composer.OPEN);
            if (!opts.action) return resolve();
          }
  
          // If it's a different draft, cancel it and try opening again.
          return self
            .cancelComposer()
            .then(function() {
              return self.open(opts);
            })
            .then(resolve, reject);
        }
  
        if (composerModel) {
          if (composerModel.get("action") !== opts.action) {
            composerModel.setProperties({ unlistTopic: false, whisper: false });
          }
        }
  
        self._setModel(composerModel, opts);
        resolve();
      });
    }
  })
  
  api.modifyClass("component:bread-crumbs", {
    hidden: function() {
      return false;
    }.property("category")
  });
  
  $(document).ready(function() {
    $('.category-breadcrumb').show();
  });
</script>