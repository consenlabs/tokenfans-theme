<script type="text/discourse-plugin" version="0.8">
  const h = require("virtual-dom").h;
  const iconNode = Discourse.__widget_helpers.iconNode

  const REPLACER = {
    bars: "/assets/images/menu.svg",
    search: "/assets/images/search.svg",
    gear: "/assets/images/settings.svg",
    user: "/assets/images/user.svg",
    "sign-out-alt": "/assets/images/logout-outline.svg",
    bookmark: "/assets/images/collect.svg",
    envelope: "/assets/images/message.svg",
    "far-envelope": "/assets/images/message-outline.svg",
    "envelope-o": "/assets/images/message-outline.svg",
    plus: "/assets/images/plus.svg",
    lock: "/assets/images/lock.svg",
    "chevron-down": "/assets/images/chevron-down.svg",
    "discourse-expand": "/assets/images/discourse-expand.svg",
    "thumbtack": "/assets/images/pin.svg",
    "thumb-tack": "/assets/images/pin.svg",
    "link": "/assets/images/link.svg",
    "close": "/assets/images/close.svg",
    "times": "/assets/images/close.svg",
    "far-image": "/assets/images/photo.svg",
  }

  const dropdown = {
    buildClasses(attrs) {
      if (attrs.active) {
        return "active";
      }
    },

    click(e) {
      e.preventDefault();
      if (!this.attrs.active) {
        this.sendWidgetAction(this.attrs.action);
      }
    }
  };

  api.createWidget(
    "header-dropdown-new",
    jQuery.extend(
      {
        tagName: "li.header-dropdown-toggle",

        html(attrs) {
          const title = I18n.t(attrs.title);

          const svg = h("img", {
            src: REPLACER[attrs.icon],
            className: `svg-icon svg-icon-${attrs.icon}`,
          })
          const body = [svg];
          if (attrs.contents) {
            body.push(attrs.contents.call(this));
          }

          return h(
            "a.icon.btn-flat",
            {
              attributes: {
                href: attrs.href,
                "data-auto-route": true,
                title,
                "aria-label": title,
                id: attrs.iconId
              }
            },
            body
          );
        }
      },
      dropdown
    )
  );

  api.reopenWidget("link", {
    html(attrs) {
      if (attrs.contents) {
        return attrs.contents();
      }
  
      const result = [];
      if (attrs.img) {
        result.push(h("img", {
          src: attrs.img
        }));
        result.push(" ");
      } else if (attrs.icon) {
        const node = REPLACER[attrs.icon] ? h("img", {
          src: REPLACER[attrs.icon],
          className: `svg-icon svg-icon-${attrs.icon}`,
        }) : iconNode(attrs.icon)
        result.push(node);
        result.push(" ");
      }
  
      if (!attrs.hideLabel) {
        let label = this.label(attrs);
  
        if (attrs.omitSpan) {
          result.push(label);
        } else {
          result.push(h("span.d-label", label));
        }
      }
  
      const currentUser = this.currentUser;
      if (currentUser && attrs.badgeCount) {
        const val = parseInt(currentUser.get(attrs.badgeCount));
        if (val > 0) {
          const title = attrs.badgeTitle ? I18n.t(attrs.badgeTitle) : "";
          result.push(" ");
          result.push(
            h(
              "span.badge-notification",
              {
                className: attrs.badgeClass,
                attributes: { title }
              },
              val
            )
          );
        }
      }
  
      return result;
    },
  })

  api.reopenWidget("header-icons", {
    html(attrs) {
      if (this.siteSettings.login_required && !this.currentUser) {
        return [];
      }
  
      const hamburger = this.attach("header-dropdown-new", {
        title: "hamburger_menu",
        icon: "bars",
        iconId: "toggle-hamburger-menu",
        active: attrs.hamburgerVisible,
        action: "toggleHamburger",
        href: "",
        contents() {
          if (!attrs.flagCount) {
            return;
          }
          return h(
            "div.badge-notification.flagged-posts",
            {
              attributes: {
                title: I18n.t("notifications.total_flagged")
              }
            },
            attrs.flagCount
          );
        }
      });
  
      const search = this.attach("header-dropdown-new", {
        title: "search.title",
        icon: "search",
        iconId: "search-button",
        action: "toggleSearchMenu",
        active: attrs.searchVisible,
        href: Discourse.getURL("/search")
      });
  
      const icons = [search];
      
      if (this.currentUser && this.currentUser.admin) {
        icons.push(hamburger);
      }

      if (attrs.user) {
        icons.push(
          this.attach("user-dropdown", {
            active: attrs.userVisible,
            action: "toggleUserMenu",
            ringBackdrop: attrs.ringBackdrop,
            user: attrs.user
          })
        );
      }
  
      return icons;
    }
  });

  api.modifyClass("component:bread-crumbs", {
    hidden: function() {
      return false;
    }.property("category")
  });
  
  $(document).ready(function() {
    $('.category-breadcrumb').show();
  });

  api.reopenWidget("user-menu", {
    panelContents() {
      const path = this.currentUser.get("path");

      let result = [
        this.attach("user-menu-links", {
          path
        }),
      ];

      if (this.state.hasUnread) {
        result.push(this.attach("user-menu-dismiss-link"));
      }
      
      result.push(this.attach("user-notifications", {
      path
      }))

      if (this.settings.showLogoutButton || this.state.hasUnread) {
        result.push(h("hr.bottom-area"));
      }

      if (this.settings.showLogoutButton) {
        result.push(
          h("div.logout-link", [
            h(
              "ul.menu-links",
              h(
                "li",
                this.attach("link", {
                  action: "logout",
                  className: "logout",
                  icon: "sign-out-alt",
                  href: "",
                  label: "user.log_out"
                })
              )
            )
          ])
        );
      }

      return result;
    },
  });

  api.reopenWidget("user-menu-links", {
    html(attrs) {
      const { currentUser, siteSettings } = this;

      const isAnon = currentUser.is_anonymous;
      const allowAnon =
        (siteSettings.allow_anonymous_posting &&
          currentUser.trust_level >=
            siteSettings.anonymous_posting_min_trust_level) ||
        isAnon;

      const path = attrs.path;
      const glyphs = [];

      glyphs.push({
        label: "user.bookmarks",
        className: "user-bookmarks-link",
        icon: "bookmark",
        href: `${path}/activity/bookmarks`
      });

      if (siteSettings.enable_personal_messages) {
        glyphs.push({
          label: "user.private_messages",
          className: "user-pms-link",
          icon: "envelope",
          href: `${path}/messages`
        });
      }

      const profileLink = {
        route: "user",
        model: currentUser,
        className: "user-activity-link",
        img: (currentUser && typeof currentUser.avatar_template === 'string') ? currentUser.avatar_template.replace('{size}', '32') : undefined,
        icon: "user",
        rawLabel: currentUser.username
      };

      if (currentUser.is_anonymous) {
        profileLink.label = "user.profile";
        profileLink.rawLabel = null;
      }

      const links = [profileLink];
      if (allowAnon) {
        if (!isAnon) {
          glyphs.push({
            action: "toggleAnonymous",
            label: "switch_to_anon",
            className: "enable-anonymous",
            icon: "user-secret"
          });
        } else {
          glyphs.push({
            action: "toggleAnonymous",
            label: "switch_from_anon",
            className: "disable-anonymous",
            icon: "ban"
          });
        }
      }

      // preferences always goes last
      glyphs.push({
        label: "user.preferences",
        className: "user-preferences-link",
        icon: "gear",
        href: `${path}/preferences/account`
      });

      return h("ul.menu-links-row", [
        links.map(l => {
          return h("li.user", this.attach("link", l))
        }),
        h(
          "li.glyphs",
          glyphs.map(l => this.attach("link", $.extend(l, { hideLabel: true })))
        )
      ]);
    }
  })

  api.reopenWidget("menu-panel", {
    buildAttributes(attrs) {
      if (attrs.maxWidth) {
        const width = window.innerWidth * 0.7
        return { "data-max-width": width };
      }
    }
  })
</script>