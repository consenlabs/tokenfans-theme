<script type="text/discourse-plugin" version="0.8">
  const h = require("virtual-dom").h;

  const REPLACER = {
    bars: "/assets/images/menu.svg",
    search: "/assets/images/search.svg"
  }

  const dropdown = {
    buildClasses(attrs) {
      if (attrs.active) {
        return "active";
      }
    },

    click(e) {
      e.preventDefault();
      if (!this.attrs.active) {
        this.sendWidgetAction(this.attrs.action);
      }
    }
  };

  api.createWidget(
    "header-dropdown-new",
    jQuery.extend(
      {
        tagName: "li.header-dropdown-toggle",

        html(attrs) {
          const title = I18n.t(attrs.title);

          const svg = h("img", {
            src: REPLACER[attrs.icon]
          })
          const body = [svg];
          if (attrs.contents) {
            body.push(attrs.contents.call(this));
          }

          return h(
            "a.icon.btn-flat",
            {
              attributes: {
                href: attrs.href,
                "data-auto-route": true,
                title,
                "aria-label": title,
                id: attrs.iconId
              }
            },
            body
          );
        }
      },
      dropdown
    )
  );

  api.reopenWidget("header-icons", {
    html(attrs) {
      if (this.siteSettings.login_required && !this.currentUser) {
        return [];
      }
  
      const hamburger = this.attach("header-dropdown-new", {
        title: "hamburger_menu",
        icon: "bars",
        iconId: "toggle-hamburger-menu",
        active: attrs.hamburgerVisible,
        action: "toggleHamburger",
        href: "",
        contents() {
          if (!attrs.flagCount) {
            return;
          }
          return h(
            "div.badge-notification.flagged-posts",
            {
              attributes: {
                title: I18n.t("notifications.total_flagged")
              }
            },
            attrs.flagCount
          );
        }
      });
  
      const search = this.attach("header-dropdown-new", {
        title: "search.title",
        icon: "search",
        iconId: "search-button",
        action: "toggleSearchMenu",
        active: attrs.searchVisible,
        href: Discourse.getURL("/search")
      });
  
      const icons = [search];
      
      if (this.currentUser && this.currentUser.admin) {
        icons.push(hamburger);
      }

      if (attrs.user) {
        icons.push(
          this.attach("user-dropdown", {
            active: attrs.userVisible,
            action: "toggleUserMenu",
            ringBackdrop: attrs.ringBackdrop,
            user: attrs.user
          })
        );
      }
  
      return icons;
    }
  });

  api.modifyClass("component:bread-crumbs", {
    hidden: function() {
      return false;
    }.property("category")
  });
  
  $(document).ready(function() {
    $('.category-breadcrumb').show();
  });

  api.modifyClass("controller:composer", {	
    open(opts) {	
      opts = opts || { };	
      if (!opts.categoryId) {	
        opts.categoryId = 11	
      }	
  	
      if (!opts.draftKey) {	
        alert("composer was opened without a draft key");	
        throw new Error("composer opened without a proper draft key");	
      }	
      const self = this;	
      let composerModel = this.get("model");	
  	
      if (	
        opts.ignoreIfChanged &&	
        composerModel &&	
        composerModel.composeState !== Composer.CLOSED	
      ) {	
        return;	
      }	
  	
      this.setProperties({	
        showEditReason: false,	
        editReason: null,	
        scopedCategoryId: null	
      });	
  	
      // If we show the subcategory list, scope the categories drop down to	
      // the category we opened the composer with.	
      if (opts.categoryId && opts.draftKey !== "reply_as_new_topic") {	
        const category = this.site.categories.findBy("id", opts.categoryId);	
        if (	
          category &&	
          (category.get("show_subcategory_list") ||	
            category.get("parentCategory.show_subcategory_list"))	
        ) {	
          this.set("scopedCategoryId", opts.categoryId);	
        }	
      }	
  	
      // If we want a different draft than the current composer, close it and clear our model.	
      if (	
        composerModel &&	
        opts.draftKey !== composerModel.draftKey &&	
        composerModel.composeState === Composer.DRAFT	
      ) {	
        this.close();	
        composerModel = null;	
      }	
  	
      return new Ember.RSVP.Promise(function(resolve, reject) {	
        if (composerModel && composerModel.get("replyDirty")) {	
          // If we're already open, we don't have to do anything	
          if (	
            composerModel.get("composeState") === Composer.OPEN &&	
            composerModel.get("draftKey") === opts.draftKey &&	
            !opts.action	
          ) {	
            return resolve();	
          }	
  	
          // If it's the same draft, just open it up again.	
          if (	
            composerModel.get("composeState") === Composer.DRAFT &&	
            composerModel.get("draftKey") === opts.draftKey	
          ) {	
            composerModel.set("composeState", Composer.OPEN);	
            if (!opts.action) return resolve();	
          }	
  	
          // If it's a different draft, cancel it and try opening again.	
          return self	
            .cancelComposer()	
            .then(function() {	
              return self.open(opts);	
            })	
            .then(resolve, reject);	
        }	
  	
        if (composerModel) {	
          if (composerModel.get("action") !== opts.action) {	
            composerModel.setProperties({ unlistTopic: false, whisper: false });	
          }	
        }	
  	
        self._setModel(composerModel, opts);	
        resolve();	
      });	
    }	
  })
</script>