<script type="text/discourse-plugin" version="0.8">
  const h = require("virtual-dom").h;
  const { iconNode } = require("discourse-common/lib/icon-library");
  const getURL = require("discourse-common/lib/get-url");

  const dropdown = {
    buildClasses(attrs) {
      if (attrs.active) {
        return "active";
      }
    },

    click(e) {
      e.preventDefault();
      if (!this.attrs.active) {
        this.sendWidgetAction(this.attrs.action);
      }
    }
  };

  api.createWidget("header-dropdown-new", jQuery.extend(
      {
        tagName: "li.header-dropdown-toggle",

        html(attrs) {
          const title = I18n.t(attrs.title);

          let svg = h("i", {
            className: `iconfont d-icon-${attrs.icon}`,
            style: 'font-size: 20px;'
          })
          const body = [svg];
          if (attrs.contents) {
            body.push(attrs.contents.call(this));
          }

          return h(
            "a.icon.btn-flat",
            {
              attributes: {
              href: attrs.href,
              "data-auto-route": true,
              title,
              "aria-label": title,
              id: attrs.iconId
            }
            },
            body
          );
        }
      },
      dropdown
      )
    );

  api.reopenWidget("header-icons", {
    html(attrs) {
      if (this.siteSettings.login_required && !this.currentUser) {
        return [];
      }
  
      const hamburger = this.attach("header-dropdown-new", {
        title: "hamburger_menu",
        icon: "bars",
        iconId: "toggle-hamburger-menu",
        active: attrs.hamburgerVisible,
        action: "toggleHamburger",
        href: "",
        contents() {
          if (!attrs.flagCount) {
            return;
          }
          return h(
            "div.badge-notification.flagged-posts",
            {
              attributes: {
                title: I18n.t("notifications.total_flagged")
              }
            },
            attrs.flagCount
          );
        }
      });
  
      const search = this.attach("header-dropdown-new", {
        title: "search.title",
        icon: "search",
        iconId: "search-button",
        action: "toggleSearchMenu",
        active: attrs.searchVisible,
        href: getURL("/search")
      });
  
      const icons = [search, hamburger];
      
      if (attrs.user) {
        icons.push(
          this.attach("user-dropdown", {
            active: attrs.userVisible,
            action: "toggleUserMenu",
            ringBackdrop: attrs.ringBackdrop,
            user: attrs.user
          })
        );
      }
  
      return icons;
    }
  });
</script>